name: Sync Fork Repositories

on:
  #   schedule:
  #     - cron: "*/10 * * * *" # 每 10 分钟触发一次
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v3

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Read repos.txt and sync forks
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          while IFS= read -r line || [[ -n "$line" ]]; do
            IFS=':' read -r upstream repo_branch fork repo_branch <<< "$line"

            upstream_url="https://$PAT@github.com/$upstream.git"
            fork_url="https://$PAT@github.com/$fork.git"

            echo "Syncing $fork_url from $upstream_url on branch $repo_branch"

            # Clone the forked repository
            git clone --single-branch --branch $repo_branch $fork_url temp-repo
            cd temp-repo

            # Add the upstream repository
            git remote add upstream $upstream_url
            git fetch upstream

            # Merge the upstream changes
            git checkout $repo_branch
            git merge upstream/$repo_branch

            # Push the changes back to the fork
            git push origin $repo_branch

            # Clean up
            cd ..
            rm -rf temp-repo
          done < repos.txt
